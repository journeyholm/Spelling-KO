<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Spelling K.O. ‚Äî The Spelling Gauntlet</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
/* Fight Font */
@import url('https://fonts.googleapis.com/css2?family=Russo+One&display=swap');
body, button, .letter, .slot { font-family: 'Russo One', sans-serif !important; letter-spacing: 1px; }
/* Prevents zooming on buttons when tapped quickly */
button, .letter, .slot { touch-action: manipulation; }

/* Loot Box Animations */
@keyframes dropIn {
    0% { transform: translateY(-100vh) rotate(10deg); opacity: 0; }
    60% { transform: translateY(20px) rotate(-5deg); opacity: 1; }
    80% { transform: translateY(-10px) rotate(2deg); }
    100% { transform: translateY(0) rotate(0); opacity: 1; }
}
.crate-drop { animation: dropIn 0.8s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
@keyframes shakeHard {
    0% { transform: translate(1px, 1px) rotate(0deg); }
    10% { transform: translate(-3px, -2px) rotate(-1deg); }
    20% { transform: translate(-3px, 0px) rotate(1deg); }
    30% { transform: translate(3px, 2px) rotate(0deg); }
    40% { transform: translate(1px, -1px) rotate(1deg); }
    50% { transform: translate(-1px, 2px) rotate(-1deg); }
    60% { transform: translate(-3px, 1px) rotate(0deg); }
    70% { transform: translate(3px, 1px) rotate(-1deg); }
    80% { transform: translate(-1px, -1px) rotate(1deg); }
    90% { transform: translate(1px, 2px) rotate(0deg); }
    100% { transform: translate(1px, -2px) rotate(-1deg); }
}
.crate-shake { animation: shakeHard 0.2s; }

/* Theme & Layout */
:root { --bg-primary: #ffffff; --bg-secondary: #f0f0f0; --text-primary: #333333; --card-bg: #e0e0e0; --accent: #ffb400; }
[data-theme="dark"] { --bg-primary: #0b1220; --bg-secondary: #071022; --text-primary: #ffffff; --card-bg: linear-gradient(180deg,#0f1724,#071022); --accent: #ffb400; }
body { font-family:Inter, sans-serif; background:var(--bg-secondary); color:var(--text-primary); padding:18px; height:100%; }
.card { background:var(--card-bg); border:1px solid rgba(255,255,255,0.04); position: relative; }

/* Game Elements */
.letter { width: 65px; height: 65px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-weight: 900; font-size: 32px; cursor:pointer; user-select:none; color: var(--text-primary); background-color: var(--bg-primary); box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
.slot { width: 65px; height: 65px; border-radius:12px; border: 4px dashed rgba(255,255,255,0.2); display:flex; align-items:center; justify-content:center; font-size: 32px; font-weight: 900; }
#score, #coins { font-size: 2rem; font-weight: 900; }

/* Feedback Popup (Fixed Position) */
#feedback { position: absolute; right: 5%; top: 55%; transform: translateY(-50%); width: 200px; text-align: center; font-size: 3rem; color: #ffb400; font-weight: 900; text-shadow: 3px 3px 0 #000; pointer-events: none; z-index: 50; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes popIn { 0% { transform: translateY(-50%) scale(0); opacity: 0; } 80% { transform: translateY(-50%) scale(1.2); opacity: 1; } 100% { transform: translateY(-50%) scale(1); opacity: 1; } }

/* Sticker & Animations */
.sticker-item { position: absolute; cursor: grab; user-select: none; transition: transform 0.1s; filter: drop-shadow(0 4px 2px rgba(0,0,0,0.3)); }
.sticker-item:active { cursor: grabbing; transform: scale(1.1); }
.puzzle-image{font-size:84px;display:inline-block;transform-origin:center bottom;}
.glove{position:absolute; right:20%; bottom:60px; font-size:64px; transform-origin:right center; z-index:2;}
.punching{animation:punchGlove 0.5s ease-out;}
.balloonHit{animation:wobbleBalloon 0.5s ease-out;}
@keyframes punchGlove{0%{transform:translateX(0) rotate(0deg);}50%{transform:translateX(-120px) rotate(-15deg);}80%{transform:translateX(-100px) rotate(5deg);}100%{transform:translateX(0) rotate(0deg);}}
@keyframes wobbleBalloon{0%{transform:rotate(0deg);}25%{transform:rotate(15deg);}50%{transform:rotate(-10deg);}75%{transform:rotate(5deg);}100%{transform:rotate(0deg);}}

/* Utils */
#levelSelect { background-color: #333 !important; color: #ffb400 !important; border: 2px solid #ffb400; }
#coins.gold-boost { color: gold; text-shadow: 0 0 5px orange; }
.streak-guard { color: #ffd700; text-shadow: 0 0 3px #ffa500; }
.modal { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.75); display: none; align-items: center; justify-content: center; z-index: 1000; }
.modal-content { background-color: white; color: #333; padding: 24px; border-radius: 12px; position: relative; max-height: 85vh; overflow-y: auto; }
/* ... (Your other styles are up here) ... */

.shake-effect {
  animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both;
}

/* *** PASTE THE NEW CODE HERE *** */
/* BOSS MODE ANIMATIONS */
@keyframes redAlarm {
    0% { background-color: var(--bg-secondary); box-shadow: inset 0 0 0 0 red; }
    50% { background-color: #3f0e0e; box-shadow: inset 0 0 100px 20px rgba(255,0,0,0.5); }
    100% { background-color: var(--bg-secondary); box-shadow: inset 0 0 0 0 red; }
}
.boss-mode {
    animation: redAlarm 1.5s infinite ease-in-out !important;
}
.boss-text {
    color: #ff0000 !important;
    text-shadow: 0 0 10px red;
    transform: scale(1.2);
}
/* LEVEL THEMES */
body.lvl-1 { background: radial-gradient(circle at center, #f0fdf4, #bbf7d0); } /* Green */
body.lvl-2 { background: radial-gradient(circle at center, #eff6ff, #bfdbfe); } /* Blue */
body.lvl-3 { background: radial-gradient(circle at center, #faf5ff, #e9d5ff); } /* Purple */
body.lvl-4 { background: radial-gradient(circle at center, #fff7ed, #fed7aa); } /* Orange */
body.lvl-5 { background: radial-gradient(circle at center, #fef2f2, #fecaca); } /* Red */

/* Dark Mode Overrides for Themes */
body[data-theme="dark"].lvl-1 { background: radial-gradient(circle at center, #052e16, #022c22); }
body[data-theme="dark"].lvl-2 { background: radial-gradient(circle at center, #172554, #0f172a); }
body[data-theme="dark"].lvl-3 { background: radial-gradient(circle at center, #3b0764, #2e1065); }
body[data-theme="dark"].lvl-4 { background: radial-gradient(circle at center, #431407, #2a0a05); }
body[data-theme="dark"].lvl-5 { background: radial-gradient(circle at center, #450a0a, #2b0808); }
/* PHONICS COLORS */
.letter.vowel {
    background: linear-gradient(135deg, #ef4444, #dc2626) !important; /* Red */
    border: 2px solid #991b1b;
    color: white;
    text-shadow: 1px 1px 0 #7f1d1d;
}
.letter.consonant {
    background: linear-gradient(135deg, #3b82f6, #2563eb) !important; /* Blue */
    border: 2px solid #1e40af;
    color: white;
    text-shadow: 1px 1px 0 #1e3a8a;
}
</style> 
</head>

<body data-theme="dark">

<div id="introScreen" class="fixed inset-0 bg-slate-900 z-[9999] flex flex-col items-center justify-center transition-opacity duration-500" style="background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);">
    <div class="text-9xl mb-6 animate-bounce drop-shadow-[0_0_35px_rgba(255,180,0,0.6)]">ü•ä</div>
    <h1 class="text-6xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-red-600 mb-4 drop-shadow-2xl" style="font-family: 'Russo One', sans-serif; letter-spacing: 4px; text-shadow: 4px 4px 0px #000;">SPELLING K.O.</h1>
    <p class="text-blue-200 text-xl md:text-2xl mb-12 font-bold tracking-widest uppercase opacity-80">The Ultimate Spelling Gauntlet</p>
    <button id="startGameBtn" class="group relative px-12 py-6 bg-yellow-400 hover:bg-yellow-300 text-black text-4xl font-black rounded-3xl shadow-[0_10px_0_rgb(161,98,7)] active:shadow-none active:translate-y-2 transition-all transform hover:scale-105">
        <span class="relative z-10 flex items-center gap-4">PLAY GAME <span class="text-3xl group-hover:translate-x-2 transition-transform">‚ñ∂</span></span>
        <div class="absolute inset-0 rounded-3xl bg-yellow-400 blur-xl opacity-50 group-hover:opacity-100 transition-opacity -z-10"></div>
    </button>
    <div class="absolute bottom-8 text-gray-500 text-sm font-bold">Press PLAY to Enable Audio</div>
</div>

<div id="app" class="max-w-4xl mx-auto">
  <div class="card p-4 rounded-xl shadow-xl">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <div class="w-14 h-14 bg-white/6 rounded-full flex items-center justify-center text-3xl">ü•ä</div>
        <div>
          <div class="text-sm text-gray-300">Spelling K.O. ‚Äî The Spelling Gauntlet</div>
          <div id="mode-label" class="text-xl font-semibold mt-0">Spelling K.O.</div>
        </div>
      </div>
      <div class="flex items-center gap-3 cursor-pointer" id="statsHeader">
        <div id="levelDisplay" class="bg-blue-500 text-white px-2 py-1 rounded font-bold">LVL 1</div> 
        <div class="text-sm text-gray-300 text-right">Coins: <span id="coins">0</span></div>
        <div class="text-xl font-bold" id="score">Score: 0</div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
      <div class="md:col-span-1 flex flex-col items-center gap-3">
        <div class="relative w-48 h-48 flex items-center justify-center">
          <div id="puzzleImage" class="puzzle-image absolute bottom-0 z-1">‚ùì</div>
          <div id="glove" class="glove">ü•ä</div>
          <div id="scorePopWrap" class="absolute inset-0 pointer-events-none"></div>
        </div>
        <div class="text-center text-sm text-gray-300">Click the image to hear the word. Correct = punch!</div>
        <button id="emojiBtn" class="text-6xl big-btn bg-white/6 rounded-xl">üîä</button>
      </div>

      <div class="md:col-span-2">
        <div class="mb-3 flex items-center justify-between">
          <div class="text-sm text-gray-300">Tap letters to build the word. Press Enter to submit.</div>
          <div class="flex gap-2">
            <select id="levelSelect" class="rounded px-2 py-1">
              <option value="1">Level 1</option>
              <option value="2">Level 2</option>
              <option value="3">Level 3</option>
              <option value="4">Level 4</option>
              <option value="5">Mixed</option>
            </select>
          </div>
        </div>

        <div id="slots" class="flex gap-2 flex-wrap mb-4"></div>
        <div id="tiles" class="flex gap-2 flex-wrap card p-3 rounded-lg"></div>

        <div class="mt-4 flex gap-2">
          <button id="submit" class="px-5 py-3 rounded bg-amber-400 text-black font-bold">Submit</button>
          <button id="new" class="px-4 py-3 rounded bg-white/6">New Word</button>
          <button id="themeToggle" class="px-4 py-3 rounded bg-white/10 text-gray-400">üåô/‚òÄÔ∏è</button>
          <button id="shopBtn" class="px-4 py-3 rounded bg-yellow-500 text-black font-bold">üí∞ Shop</button>
          <button id="stickerBtn" class="px-4 py-3 rounded bg-purple-600 text-white font-bold border-2 border-purple-400 shadow-md">üìí Stickers</button>
          <div id="feedback" class="ml-2 text-lg font-semibold"></div>
        </div>

        <div class="mt-3" id="xpContainer">
            <div class="w-full bg-gray-800 rounded-full h-6 relative border-2 border-gray-600 overflow-hidden shadow-lg mb-2">
                <div id="streakBar" class="h-full bg-gradient-to-r from-yellow-400 to-red-500 transition-all duration-300" style="width: 0%;"></div>
                <div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white shadow-black drop-shadow-md">
                    COMBO: <span id="streak" class="ml-1">0</span>
                </div>
            </div>
            <div class="text-xs text-gray-500 text-center font-bold">XP: <span id="xp">0</span>/<span id="xpNext">50</span></div>
        </div>
      </div>
    </div>
  </div>
  
  <div id="shopModal" class="fixed inset-0 bg-black/75 flex items-center justify-center hidden z-50">
    <div class="modal-content w-11/12 max-w-lg">
      <h2 class="text-3xl font-bold mb-4">The Glove Shop</h2>
      <div id="shopContent" class="overflow-y-auto"></div>
      <button id="closeShop" class="mt-4 px-4 py-2 bg-gray-400 hover:bg-gray-500 rounded font-semibold">Close</button>
    </div>
  </div>

  <div id="progressModal" class="modal">
    <div class="modal-content w-11/12 max-w-md">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">Player Stats & Progress</h2>
            <button id="closeProgressModal" class="text-xl font-bold p-1">&times;</button>
        </div>
        <div id="progressContent" class="text-left space-y-2"></div>
    </div>
  </div>

  <div id="cutscene-layer" style="display:none; position:fixed; inset:0; z-index:9999; background:#050510;"></div>
</div>

<div id="stickerModal" class="modal" style="display:none;">
    <div class="modal-content w-full h-full max-w-5xl max-h-[90vh] flex flex-col bg-slate-900 border-4 border-purple-500 rounded-3xl overflow-hidden">
        <div class="flex justify-between items-center p-4 bg-slate-800 border-b-4 border-slate-700">
            <div>
                <h2 class="text-3xl font-black text-purple-400 drop-shadow-md">üìí MY STICKER BOOK</h2>
                <div class="text-sm text-gray-400 font-bold">TAP to Select ‚Ä¢ Use Buttons to Resize/Delete</div>
            </div>
            <button id="closeStickerModal" class="text-3xl font-bold bg-red-500 hover:bg-red-400 text-white rounded-lg px-4 py-1 shadow-lg">&times;</button>
        </div>
        <div id="stickerCanvas" class="flex-1 bg-white relative overflow-hidden shadow-inner touch-none cursor-crosshair">
            <div class="absolute inset-0 opacity-20" style="background-image: linear-gradient(#ccc 1px, transparent 1px), linear-gradient(90deg, #ccc 1px, transparent 1px); background-size: 40px 40px;"></div>
        </div>
        <div class="h-32 bg-slate-800 border-t-4 border-slate-700 p-4 flex gap-4 overflow-x-auto items-center" id="stickerDrawer"></div>
    </div>
</div>

<div id="lootOverlay" class="fixed inset-0 bg-black/90 z-[10000] hidden flex-col items-center justify-center">
    <h2 class="text-white text-4xl font-black mb-8 animate-pulse text-center">LEVEL COMPLETE!<br><span class="text-yellow-400 text-2xl">TAP THE CRATE TO OPEN!</span></h2>
    <div id="lootCrate" class="text-[150px] cursor-pointer select-none transition-transform active:scale-95 drop-shadow-[0_0_50px_rgba(255,255,255,0.2)]">üì¶</div>
    <div id="lootRewards" class="hidden flex-col items-center gap-4 animate-bounce-in">
        <div class="text-white text-3xl font-bold">YOU FOUND:</div>
        <div id="lootItems" class="flex gap-4 justify-center flex-wrap"></div>
        <button id="collectLootBtn" class="mt-8 px-8 py-4 bg-green-500 hover:bg-green-400 text-white font-black text-2xl rounded-2xl shadow-lg border-b-8 border-green-700 active:border-b-0 active:translate-y-2">COLLECT!</button>
    </div>
</div>

<script>
// --- DATA: RESTORED EMOJIS ---
const WORD_SETS = {
  1: [ {word:'CAT', emoji:'üê±'}, {word:'DOG', emoji:'üê∂'}, {word:'SUN', emoji:'‚òÄÔ∏è'}, {word:'BED', emoji:'üõèÔ∏è'}, {word:'HAT', emoji:'üé©'}, {word:'MUG', emoji:'‚òï'}, {word:'FOG', emoji:'üå´Ô∏è'}, {word:'RUG', emoji:'üõãÔ∏è'}, {word:'BUS', emoji:'üöå'}, {word:'PIG', emoji:'üê∑'}, {word:'MAP', emoji:'üó∫Ô∏è'}, {word:'FOX', emoji:'ü¶ä'}, {word:'KEY', emoji:'üîë'}, {word:'JAM', emoji:'üçì'}, {word:'PEN', emoji:'üñäÔ∏è'}, {word:'TEN', emoji:'üîü'}, {word:'NET', emoji:'ü•Ö'}, {word:'WET', emoji:'üíß'}, {word:'MOP', emoji:'üßπ'}, {word:'TOP', emoji:'üîù'}, {word:'VAN', emoji:'üöê'}, {word:'WAX', emoji:'üïØÔ∏è'}, {word:'BOX', emoji:'üì¶'}, {word:'HEN', emoji:'üêî'}, {word:'FIN', emoji:'ü¶à'}, {word:'LIP', emoji:'üëÑ'}, {word:'ZIP', emoji:'ü§ê'}, {word:'JOG', emoji:'üèÉ'}, {word:'BAG', emoji:'üõçÔ∏è'}, {word:'TAG', emoji:'üè∑Ô∏è'}, {word:'CAB', emoji:'üöï'}, {word:'MAD', emoji:'üò°'}, {word:'DAD', emoji:'üë®‚Äçüëß‚Äçüë¶'}, {word:'SAD', emoji:'üòû'}, {word:'PAD', emoji:'üìù'}, {word:'GUM', emoji:'üç¨'}, {word:'TUB', emoji:'üõÅ'}, {word:'NUT', emoji:'üå∞'}, {word:'CUT', emoji:'‚úÇÔ∏è'}, {word:'SIT', emoji:'ü™ë'}, {word:'HIT', emoji:'üí•'}, {word:'FIT', emoji:'üí™'}, {word:'SIX', emoji:'6Ô∏è‚É£'}, {word:'MIX', emoji:'üîÄ'}, {word:'WIG', emoji:'üë©‚Äçü¶±'}, {word:'FIG', emoji:'ü•ù'}, {word:'JET', emoji:'‚úàÔ∏è'}, {word:'LEG', emoji:'ü¶µ'}, {word:'HOG', emoji:'üêó'}, {word:'DOT', emoji:'üî¥'}, {word:'WEB', emoji:'üï∏Ô∏è'}, {word:'CAN', emoji:'ü•´'}, {word:'LAD', emoji:'üë¶'}, {word:'LID', emoji:'üçæ'}, {word:'YEP', emoji:'‚úÖ'}, {word:'COB', emoji:'üåΩ'}, {word:'GAB', emoji:'üó£Ô∏è'}, {word:'JOB', emoji:'üíº'}, {word:'COD', emoji:'üêü'}, {word:'JIB', emoji:'‚õµ'}, {word:'GOT', emoji:'üì•'}, {word:'HIS', emoji:'üëÜ'}, {word:'HOW', emoji:'‚ùì'} ],
  2: [ {word:'CAKE', emoji:'üéÇ'}, {word:'GUST', emoji:'üí®'}, {word:'FISH', emoji:'üêü'}, {word:'BIKE', emoji:'üö≤'}, {word:'NOTE', emoji:'üìù'}, {word:'TREE', emoji:'üå≥'}, {word:'WAVE', emoji:'üåä'}, {word:'GAME', emoji:'üéÆ'}, {word:'HOME', emoji:'üè†'}, {word:'CUBE', emoji:'üßä'}, {word:'ROSE', emoji:'üåπ'}, {word:'FIRE', emoji:'üî•'}, {word:'SHOE', emoji:'üëü'}, {word:'FROG', emoji:'üê∏'}, {word:'FLAG', emoji:'üö©'}, {word:'DRUM', emoji:'ü•Å'}, {word:'SLIP', emoji:'üõº'}, {word:'PLUG', emoji:'üîå'}, {word:'TWIN', emoji:'üëØ‚Äç‚ôÄÔ∏è'}, {word:'STEP', emoji:'üë£'}, {word:'GRIN', emoji:'üòÅ'}, {word:'GLOW', emoji:'‚ú®'}, {word:'STAR', emoji:'‚≠ê'}, {word:'SHIP', emoji:'üö¢'}, {word:'SWAN', emoji:'ü¶¢'}, {word:'TRAP', emoji:'ü™§'}, {word:'BRAG', emoji:'üó£Ô∏è'}, {word:'CLIP', emoji:'üìé'}, {word:'DROP', emoji:'üíß'}, {word:'SPOT', emoji:'‚ö´'}, {word:'TUBE', emoji:'üß¥'}, {word:'RIDE', emoji:'üé¢'}, {word:'DIME', emoji:'ü™ô'}, {word:'LAKE', emoji:'üèûÔ∏è'}, {word:'RULE', emoji:'üìè'}, {word:'VOTE', emoji:'üó≥Ô∏è'}, {word:'DUCK', emoji:'ü¶Ü'}, {word:'MILK', emoji:'ü•õ'}, {word:'HAND', emoji:'‚úã'}, {word:'TENT', emoji:'‚õ∫'}, {word:'JUMP', emoji:'ü§∏'}, {word:'KITE', emoji:'ü™Å'}, {word:'BUMP', emoji:'üí•'}, {word:'MASK', emoji:'üé≠'}, {word:'POND', emoji:'üèûÔ∏è'}, {word:'YARN', emoji:'üß∂'}, {word:'WOLF', emoji:'üê∫'}, {word:'PINK', emoji:'üå∏'}, {word:'BELT', emoji:'ü•ã'}, {word:'GIFT', emoji:'üéÅ'}, {word:'NEST', emoji:'ü™π'}, {word:'SPIN', emoji:'üí´'}, {word:'SLOB', emoji:'ü§Æ'}, {word:'CLAN', emoji:'üë®‚Äçüë©‚Äçüëß'}, {word:'FLIP', emoji:'ü§∏'}, {word:'CLOP', emoji:'üê¥'}, {word:'BRIM', emoji:'üß¢'}, {word:'BLOT', emoji:'üßª'}, {word:'CRUX', emoji:'‚úùÔ∏è'}, {word:'FLAT', emoji:'üìê'}, {word:'GRIP', emoji:'ü§ù'}, {word:'HUMP', emoji:'üê™'}, {word:'JILT', emoji:'üíî'}, {word:'LISP', emoji:'üëÖ'}, {word:'MUST', emoji:'üìù'}, {word:'SHED', emoji:'üè°'}, {word:'SOAP', emoji:'üßº'}, {word:'STEM', emoji:'üå±'}, {word:'TUCK', emoji:'üß∫'}, {word:'TWIG', emoji:'üåø'} ],
  3: [ {word:'APPLE', emoji:'üçé'}, {word:'PLANT', emoji:'ü™¥'}, {word:'SWEEP', emoji:'üßπ'}, {word:'GLOBE', emoji:'üåç'}, {word:'HOUSE', emoji:'üè†'}, {word:'SNAKE', emoji:'üêç'}, {word:'WATER', emoji:'üíß'}, {word:'TIGER', emoji:'üêØ'}, {word:'FANCY', emoji:'üíé'}, {word:'SHARK', emoji:'ü¶à'}, {word:'HEART', emoji:'‚ù§Ô∏è'}, {word:'PIRATE', emoji:'üè¥‚Äç‚ò†Ô∏è'}, {word:'DRAGON', emoji:'üêâ'}, {word:'CHEST', emoji:'üì¶'}, {word:'CLOUD', emoji:'‚òÅÔ∏è'}, {word:'TRAIN', emoji:'üöÇ'}, {word:'PANDA', emoji:'üêº'}, {word:'FROSTY', emoji:'‚ùÑÔ∏è'}, {word:'CROWD', emoji:'üßç'}, {word:'SCREAM', emoji:'üò±'}, {word:'TRICKY', emoji:'üÉè'}, {word:'QUEEN', emoji:'üëë'}, {word:'SPOON', emoji:'ü•Ñ'}, {word:'GRASS', emoji:'üåø'}, {word:'CRUNCH', emoji:'üçé'}, {word:'BRUSH', emoji:'üñåÔ∏è'}, {word:'CHILL', emoji:'ü•∂'}, {word:'SWING', emoji:'üêí'}, {word:'TRUMP', emoji:'üé∫'}, {word:'SLIDE', emoji:'üõù'}, {word:'BLANK', emoji:'‚¨ú'}, {word:'FRESH', emoji:'ü•¨'}, {word:'GRACE', emoji:'üíÉ'}, {word:'PRINT', emoji:'üñ®Ô∏è'}, {word:'CLERK', emoji:'üßë‚Äçüíº'}, {word:'FLUTE', emoji:'üé∂'}, {word:'CRANE', emoji:'üèóÔ∏è'}, {word:'SPIKE', emoji:'üî™'}, {word:'SWELL', emoji:'üíß'}, {word:'BLESS', emoji:'üôè'}, {word:'GLAZE', emoji:'üç©'}, {word:'FIGHT', emoji:'‚öîÔ∏è'}, {word:'COUCH', emoji:'üõãÔ∏è'}, {word:'STORM', emoji:'‚õàÔ∏è'}, {word:'THUMB', emoji:'üëç'}, {word:'SHINE', emoji:'üîÜ'}, {word:'DRIVE', emoji:'üöó'}, {word:'CLOWN', emoji:'ü§°'}, {word:'SWIRL', emoji:'üç•'}, {word:'BLADE', emoji:'üî™'}, {word:'WHALE', emoji:'üê≥'}, {word:'GHOST', emoji:'üëª'}, {word:'WHIRL', emoji:'üå™Ô∏è'}, {word:'CATCH', emoji:'üß§'}, {word:'SMOKE', emoji:'üí®'}, {word:'TRASH', emoji:'üóëÔ∏è'}, {word:'CRUST', emoji:'üçû'}, {word:'PLUME', emoji:'üí®'}, {word:'ACORN', emoji:'üå∞'}, {word:'SPANK', emoji:'‚úã'}, {word:'GLORY', emoji:'üåü'}, {word:'TWIRL', emoji:'üíÉ'}, {word:'SLUMP', emoji:'üòî'}, {word:'CHURN', emoji:'üêÑ'}, {word:'FLUSH', emoji:'üöΩ'}, {word:'GRUMP', emoji:'üò†'}, {word:'BLAST', emoji:'üí•'}, {word:'SHAME', emoji:'üò≥'}, {word:'BLEAK', emoji:'üòî'}, {word:'PLUSH', emoji:'üß∏'}, {word:'WRING', emoji:'üßº'} ],
  4: [ {word:'FLOWER', emoji:'üå∏'}, {word:'MONKEY', emoji:'üêí'}, {word:'BANANA', emoji:'üçå'}, {word:'ROCKET', emoji:'üöÄ'}, {word:'BUTTON', emoji:'üîò'}, {word:'WINDOW', emoji:'üñºÔ∏è'}, {word:'GARAGE', emoji:'üöó'}, {word:'CASTLE', emoji:'üè∞'}, {word:'WIZARD', emoji:'üßô‚Äç‚ôÇÔ∏è'}, {word:'PURPLE', emoji:'üü£'}, {word:'ORANGE', emoji:'üçä'}, {word:'TURTLE', emoji:'üê¢'}, {word:'SHADOW', emoji:'üë§'}, {word:'CLOUDY', emoji:'‚òÅÔ∏è'}, {word:'LITTLE', emoji:'ü§è'}, {word:'PENCIL', emoji:'‚úèÔ∏è'}, {word:'PLANET', emoji:'ü™ê'}, {word:'TRAVEL', emoji:'üó∫Ô∏è'}, {word:'DRAGON', emoji:'üêâ'}, {word:'FINGER', emoji:'üëÜ'}, {word:'SILVER', emoji:'ü™ô'}, {word:'HAPPEN', emoji:'ü§Ø'}, {word:'RETURN', emoji:'‚Ü©Ô∏è'}, {word:'NUMBER', emoji:'üî¢'}, {word:'SISTER', emoji:'üëß'}, {word:'BROKEN', emoji:'üíî'}, {word:'SQUARE', emoji:'üü™'}, {word:'CIRCLE', emoji:'‚ö™'}, {word:'YELLOW', emoji:'üü°'}, {word:'COFFEE', emoji:'‚òï'}, {word:'FLIGHT', emoji:'üõ´'}, {word:'WONDER', emoji:'‚ùì'}, {word:'CHURCH', emoji:'‚õ™'}, {word:'POCKET', emoji:'üëñ'}, {word:'TICKET', emoji:'üé´'}, {word:'SWEET', emoji:'üç¨'}, {word:'SPRING', emoji:'üå∑'}, {word:'STREAM', emoji:'üèûÔ∏è'}, {word:'HEALTH', emoji:'‚ù§Ô∏è'}, {word:'SUGGEST', emoji:'ü§î'}, {word:'SECRET', emoji:'ü§´'}, {word:'CAREFUL', emoji:'‚ö†Ô∏è'}, {word:'EXAMPLE', emoji:'üí°'}, {word:'ADDRESS', emoji:'üè†'}, {word:'BALANCE', emoji:'‚öñÔ∏è'}, {word:'BASKET', emoji:'üß∫'}, {word:'GUITAR', emoji:'üé∏'}, {word:'PUPPET', emoji:'üé≠'}, {word:'LADDER', emoji:'ü™ú'}, {word:'SILENT', emoji:'ü§´'}, {word:'QUIVER', emoji:'üèπ'}, {word:'FLICKER', emoji:'üïØÔ∏è'}, {word:'SNOWMAN', emoji:'‚õÑ'}, {word:'CHICKEN', emoji:'üêî'}, {word:'PROBLEM', emoji:'‚ùì'}, {word:'SPARROW', emoji:'üê¶'}, {word:'MEASURE', emoji:'üìè'}, {word:'BALANCE', emoji:'‚öñÔ∏è'}, {word:'ADULT', emoji:'üßë'}, {word:'ELEVATOR', emoji:'‚¨ÜÔ∏è'}, {word:'CHESTNUT', emoji:'üå∞'}, {word:'DISCUSS', emoji:'üí¨'}, {word:'ELEMENT', emoji:'üß™'}, {word:'HISTORY', emoji:'üìú'}, {word:'MAGICAL', emoji:'ü™Ñ'}, {word:'MARVEL', emoji:'üòÆ'}, {word:'PERFECT', emoji:'üíØ'}, {word:'SUCCESS', emoji:'‚úÖ'}, {word:'TREASURE', emoji:'üíé'}, {word:'WONDER', emoji:'‚ú®'} ],
  5: [ {word:'DRAGON', emoji:'üêâ'}, {word:'BASKET', emoji:'üß∫'}, {word:'GUITAR', emoji:'üé∏'}, {word:'PENCIL', emoji:'‚úèÔ∏è'}, {word:'PLANET', emoji:'ü™ê'}, {word:'WIZARD', emoji:'üßô‚Äç‚ôÇÔ∏è'}, {word:'CASTLE', emoji:'üè∞'}, {word:'JOURNEY', emoji:'üó∫Ô∏è'}, {word:'MOUNTAIN', emoji:'üèîÔ∏è'}, {word:'TREASURE', emoji:'üíé'}, {word:'CHAMPION', emoji:'üëë'}, {word:'DIAMOND', emoji:'üíç'}, {word:'EAGLE', emoji:'ü¶Ö'}, {word:'WHISPER', emoji:'ü§´'}, {word:'VOLCANO', emoji:'üåã'}, {word:'LANGUAGE', emoji:'üó£Ô∏è'}, {word:'COMPUTER', emoji:'üíª'}, {word:'EXCELLENT', emoji:'‚≠ê'}, {word:'MAGNETIC', emoji:'üß≤'}, {word:'HARVEST', emoji:'üåæ'}, {word:'DISCOVER', emoji:'üîé'}, {word:'HISTORY', emoji:'üìú'}, {word:'ADVENTURE', emoji:'üéí'}, {word:'EXPLORER', emoji:'üß≠'}, {word:'FORTRESS', emoji:'üõ°Ô∏è'}, {word:'GLADIATOR', emoji:'‚öîÔ∏è'}, {word:'MAJESTY', emoji:'üëë'}, {word:'MYSTERY', emoji:'‚ùì'}, {word:'TEMPLE', emoji:'üóø'}, {word:'WONDERFUL', emoji:'ü§©'}, {word:'DELICIOUS', emoji:'üòã'}, {word:'FANTASTIC', emoji:'‚ú®'}, {word:'IMAGINE', emoji:'üí≠'}, {word:'PERFECT', emoji:'üíØ'}, {word:'SUCCESS', emoji:'‚úÖ'}, {word:'UNIVERSE', emoji:'üåå'}, {word:'COMFORT', emoji:'üõãÔ∏è'}, {word:'DELIGHT', emoji:'üòÑ'}, {word:'FICTION', emoji:'üìö'}, {word:'GENIUS', emoji:'üß†'}, {word:'HONEST', emoji:'ü§ù'}, {word:'INVEST', emoji:'üí∞'}, {word:'KNOWLEDGE', emoji:'üéì'}, {word:'LIBERTY', emoji:'üóΩ'}, {word:'MIRACLE', emoji:'üåü'}, {word:'NOURISH', emoji:'üçé'}, {word:'OPPOSITE', emoji:'üîÄ'}, {word:'PASSION', emoji:'üî•'}, {word:'QUALITY', emoji:'üíé'}, {word:'SINCERE', emoji:'üíñ'}, {word:'ACCOMPLISH', emoji:'‚úÖ'}, {word:'CHALLENGE', emoji:'üßó'}, {word:'EDUCATION', emoji:'üéì'}, {word:'ENTERPRISE', emoji:'üöÄ'}, {word:'EXPERIENCE', emoji:'üí°'}, {word:'GOVERNMENT', emoji:'üèõÔ∏è'}, {word:'IMPROVEMENT', emoji:'üìà'}, {word:'INTELLIGENCE', emoji:'üß†'}, {word:'LEADERSHIP', emoji:'üëë'}, {word:'MANAGEMENT', emoji:'üíº'}, {word:'OPPORTUNITY', emoji:'üéÅ'}, {word:'PARTNERSHIP', emoji:'ü§ù'}, {word:'PERFORMANCE', emoji:'üèÜ'}, {word:'PROFESSIONAL', emoji:'üßë‚Äçüíº'}, {word:'RESPONSIBLE', emoji:'üõ°Ô∏è'}, {word:'STRATEGY', emoji:'‚ôüÔ∏è'}, {word:'TECHNOLOGY', emoji:'ü§ñ'}, {word:'UNDERSTAND', emoji:'ü§î'}, {word:'VISIONARY', emoji:'üëÅÔ∏è'}, {word:'WELLNESS', emoji:'‚öïÔ∏è'} ]
};

const GLOVE_DATA = {
    'base': { name: 'Red Boxer', emoji: 'ü•ä', price: 0, perk: 'None' },
    'training': { name: 'Karate', emoji: 'ü•ã', price: 15, perk: '+1 XP per word' },
    'sparkle': { name: 'Sparkle', emoji: '‚ú®', price: 40, perk: '+1 Coin per word' },
    'robot': { name: 'Robo-Grip', emoji: 'ü¶æ', price: 10, perk: 'Just for looks!' },
    'zombie': { name: 'Zombie Hand', emoji: 'üßü', price: 10, perk: 'Just for looks!' },
    'alien': { name: 'Alien Claw', emoji: 'üëΩ', price: 10, perk: 'Just for looks!' },
    'princess': { name: 'Royal Wave', emoji: 'üëã', price: 20, perk: 'Just for looks!' },
    'skeleton': { name: 'Bone Hand', emoji: 'üíÄ', price: 15, perk: 'Just for looks!' },
    'cat': { name: 'Kitty Paw', emoji: 'üêæ', price: 20, perk: 'Meow!' },
    'ice': { name: 'Ice Breaker', emoji: 'üßä', price: 25, perk: 'So Cool!' },
    'fire': { name: 'Fireball', emoji: 'üî•', price: 25, perk: 'Super Hot!' },
    'cactus': { name: 'Prickly', emoji: 'üåµ', price: 15, perk: 'Don\'t touch!' },
    'crab': { name: 'Crab Pinch', emoji: 'ü¶Ä', price: 20, perk: 'Snip Snip!' },
    'gold': { name: 'Gold Glove', emoji: 'ü•á', price: 150, perk: 'Big Score Bonus!' },
};

const STICKER_DATA = {
    's_cat': { name: 'Kitty', emoji: 'üê±', price: 15 },
    's_dog': { name: 'Puppy', emoji: 'üê∂', price: 15 },
    's_rex': { name: 'T-Rex', emoji: 'ü¶ñ', price: 25 },
    's_unicorn': { name: 'Unicorn', emoji: 'ü¶Ñ', price: 25 },
    's_panda': { name: 'Panda', emoji: 'üêº', price: 20 },
    's_lion': { name: 'Lion', emoji: 'ü¶Å', price: 20 },
    's_crab': { name: 'Crab', emoji: 'ü¶Ä', price: 15 },
    's_butterfly': { name: 'Butterfly', emoji: 'ü¶ã', price: 10 },
    's_pizza': { name: 'Pizza', emoji: 'üçï', price: 10 },
    's_donut': { name: 'Donut', emoji: 'üç©', price: 10 },
    's_icecream': { name: 'Ice Cream', emoji: 'üç¶', price: 10 },
    's_burger': { name: 'Burger', emoji: 'üçî', price: 15 },
    's_apple': { name: 'Apple', emoji: 'üçé', price: 5 },
    's_rocket': { name: 'Rocket', emoji: 'üöÄ', price: 20 },
    's_star': { name: 'Star', emoji: '‚≠ê', price: 10 },
    's_moon': { name: 'Moon', emoji: 'üåô', price: 15 },
    's_planet': { name: 'Planet', emoji: 'ü™ê', price: 20 },
    's_alien': { name: 'Alien', emoji: 'üëΩ', price: 20 },
    's_smile': { name: 'Big Smile', emoji: 'üòÑ', price: 5 },
    's_cool': { name: 'Cool Guy', emoji: 'üòé', price: 10 },
    's_love': { name: 'Love', emoji: '‚ù§Ô∏è', price: 10 },
    's_poop': { name: 'Silly Poop', emoji: 'üí©', price: 15 },
    's_ghost': { name: 'Ghost', emoji: 'üëª', price: 15 },
    's_fire': { name: 'Fire', emoji: 'üî•', price: 15 },
    's_crown': { name: 'Crown', emoji: 'üëë', price: 30 },
};

// --- GLOBAL STATE ---
let shopTab = 'gloves'; 
let store = JSON.parse(localStorage.getItem('spellingBalloon_v2')||'{}');
let coins = store.coins||0, score=store.score||0, xp=store.xp||0, streak=store.streak||0;
let maxStreak = store.maxStreak||0; 
let wordsSpelled = store.wordsSpelled || 0;
let currentGlove = store.currentGlove||'base'; 
let ownedGloves = store.ownedGloves || ['base'];
let ownedStickers = store.ownedStickers || [];
let placedStickers = store.placedStickers || [];
let levelChoice = parseInt(store.levelChoice||1);
let currentWordData = null; 
let currentWord=null, userAnswer=[];
let isAnimating = false; 
let coinRushCounter = store.coinRushCounter || 0;
let currentWordFailed = false;
let roundWins = store.roundWins || 0; 
let isBossRound = false;
const COIN_RUSH_DURATION = 15;
const COIN_RUSH_MULTIPLIER = 5;

// Sounds
const correctSound = new Audio('https://s3.amazonaws.com/iamlab/audio/chime_success.mp3'); 
const wrongSound = new Audio('https://s3.amazonaws.com/iamlab/audio/buzz_fail.mp3');
const punchSound = new Audio('https://s3.amazonaws.com/iamlab/audio/punch_impact.mp3');
const levelUpSound = new Audio('https://s3.amazonaws.com/iamlab/audio/level_up_fanfare.mp3');

// DOM Elements
const el={
  glove: document.getElementById('glove'),
  puzzleImage: document.getElementById('puzzleImage'), 
  score: document.getElementById('score'),
  slots: document.getElementById('slots'),
  tiles: document.getElementById('tiles'),
  submit: document.getElementById('submit'),
  newBtn: document.getElementById('new'),
  emojiBtn: document.getElementById('emojiBtn'),
  feedback: document.getElementById('feedback'),
  xp: document.getElementById('xp'),
  xpNext: document.getElementById('xpNext'),
  streak: document.getElementById('streak'),
  coins: document.getElementById('coins'),
  scorePopWrap: document.getElementById('scorePopWrap'),
  levelSelect: document.getElementById('levelSelect'),
  themeToggle: document.getElementById('themeToggle'),
  levelDisplay: document.getElementById('levelDisplay'), 
  xpContainer: document.getElementById('xpContainer'),
  shopModal: document.getElementById('shopModal'),
  shopContent: document.getElementById('shopContent'),
  closeShop: document.getElementById('closeShop'),
  shopBtn: document.getElementById('shopBtn'),
  progressModal: document.getElementById('progressModal'),
  closeProgressModal: document.getElementById('closeProgressModal'),
  progressContent: document.getElementById('progressContent'),
  statsHeader: document.getElementById('statsHeader'),
  stickerBtn: document.getElementById('stickerBtn'),
  stickerModal: document.getElementById('stickerModal'),
  closeStickerModal: document.getElementById('closeStickerModal'),
  stickerCanvas: document.getElementById('stickerCanvas'),
  stickerDrawer: document.getElementById('stickerDrawer')
};

// --- UTILITY FUNCTIONS ---
function shuffle(a){ return a.slice().sort(()=>0.5-Math.random()); }

// --- NEW VOICE SETUP ---
let availableVoices = [];

// Force browser to load voices immediately (Fixes the "robotic default" issue)
window.speechSynthesis.onvoiceschanged = () => {
    availableVoices = window.speechSynthesis.getVoices();
};

function playSpeech(text){ 
  try{ 
    // 1. Stop any previous talking immediately
    window.speechSynthesis.cancel(); 
    
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'en-US'; 
    
    // ** NEW SETTINGS FOR CLARITY **
    u.rate = 0.9;   // Clear speed (not too fast, not too slow)
    u.pitch = 1.0;  // Natural pitch (Removes the digital squeak)
    u.volume = 1.0; 

    // 2. Load voices if they haven't loaded yet
    if (availableVoices.length === 0) {
        availableVoices = window.speechSynthesis.getVoices();
    }

    // 3. Find the best "Human-sounding" voice available
    const bestVoice = availableVoices.find(v => v.name.includes("Google US English")) // Best on Chrome
                   || availableVoices.find(v => v.name.includes("Samantha"))          // Best on Mac/iPad
                   || availableVoices.find(v => v.name.includes("Microsoft Zira"))    // Best on Windows
                   || availableVoices.find(v => v.lang === 'en-US');                  
    
    if (bestVoice) u.voice = bestVoice;

    window.speechSynthesis.speak(u); 
  } catch(e){console.warn(e);} 
}

/* ======================= Cutscene Module ======================= */
const VictoryScene = {
    scene: null, camera: null, renderer: null, clock: null,
    boxer: null, mixer: null, animationId: null,
    letterBoxes: [], particles: [], confetti: [],
    timeline: 0, isAnimating: false, currentStep: 0,
    container: null,
    SEQUENCE: [
        { time: 0.8, char: 'W', pos: -3, hand: 'left', spawned: false, punched: false },
        { time: 1.8, char: 'I', pos: 0, hand: 'right', spawned: false, punched: false },
        { time: 2.8, char: 'N', pos: 3, hand: 'left', finish: true, spawned: false, punched: false }
    ],
    init() {
        this.container = document.getElementById("cutscene-layer");
        if (!this.container) return;
        this.container.innerHTML = '';
        this.scene = new THREE.Scene();
        this.scene.background = new THREE.Color(0x050510);
        this.scene.fog = new THREE.FogExp2(0x050510, 0.02);
        this.camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        this.camera.position.set(0, 2, 8);
        this.camera.lookAt(0, 1, 0);
        this.renderer = new THREE.WebGLRenderer({ antialias: true });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.shadowMap.enabled = true;
        this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        this.container.appendChild(this.renderer.domElement);
        this.setupLights();
        this.createArena();
        this.boxer = this.createBoxer();
        this.scene.add(this.boxer.mesh);
        this.clock = new THREE.Clock();
        window.addEventListener('resize', () => this.onWindowResize(), false);
    },
    start() {
        if (!this.container || !this.renderer) this.init();
        if (!this.container) return;
        this.container.style.display = "block";
        this.container.style.opacity = "1";
        this.resetState();
        this.isAnimating = true;
        this.animate();
        setTimeout(() => { this.stop(); }, 6000);
    },
    stop() {
        this.isAnimating = false;
        if (this.animationId) cancelAnimationFrame(this.animationId);
        this.container.style.opacity = "0";
        setTimeout(() => {
            this.container.style.display = "none";
            triggerLootBox(); 
        }, 1000);
    },
    resetState() {
        this.timeline = 0;
        this.currentStep = 0;
        this.letterBoxes.forEach(b => this.scene.remove(b));
        this.particles.forEach(p => this.scene.remove(p));
        this.confetti.forEach(c => this.scene.remove(c));
        this.letterBoxes = [];
        this.particles = [];
        this.confetti = [];
        this.SEQUENCE.forEach(s => { s.spawned = false; s.punched = false; });
        if(this.boxer) {
            this.boxer.leftArm.rotation.set(0.78, 0, 0.39);
            this.boxer.rightArm.rotation.set(0.78, 0, -0.39);
        }
    },
    setupLights() {
        const ambient = new THREE.AmbientLight(0x404040);
        this.scene.add(ambient);
        const spotLight = new THREE.SpotLight(0xffffff, 1);
        spotLight.position.set(0, 15, 5);
        spotLight.angle = Math.PI / 4;
        spotLight.penumbra = 0.5;
        spotLight.castShadow = true;
        this.scene.add(spotLight);
        const backLight = new THREE.PointLight(0x0088ff, 1, 20);
        backLight.position.set(-5, 5, -5);
        this.scene.add(backLight);
        const backLight2 = new THREE.PointLight(0xff0088, 1, 20);
        backLight2.position.set(5, 5, -5);
        this.scene.add(backLight2);
    },
    createArena() {
        const floorGeo = new THREE.PlaneGeometry(20, 20);
        const floorMat = new THREE.MeshStandardMaterial({ color: 0x222222, roughness: 0.8, metalness: 0.2 });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        this.scene.add(floor);
    },
    createBoxer() {
        const group = new THREE.Group();
        const skinMat = new THREE.MeshLambertMaterial({ color: 0x8d5524 });
        const gloveMat = new THREE.MeshPhongMaterial({ color: 0xcc0000, shininess: 100 });
        const shortsMat = new THREE.MeshLambertMaterial({ color: 0x0033cc });
        const torso = new THREE.Mesh(new THREE.BoxGeometry(1, 1.5, 0.6), skinMat);
        torso.position.y = 2.2; torso.castShadow = true; group.add(torso);
        const shorts = new THREE.Mesh(new THREE.BoxGeometry(1.05, 0.8, 0.65), shortsMat);
        shorts.position.y = 1.4; shorts.castShadow = true; group.add(shorts);
        const head = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.6, 0.5), skinMat);
        head.position.y = 3.3; head.castShadow = true; group.add(head);
        function createArm(x, isLeft) {
            const armGroup = new THREE.Group();
            armGroup.position.set(x, 2.8, 0);
            const upper = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.15, 0.8), skinMat);
            upper.position.y = -0.4; armGroup.add(upper);
            const foreArmGroup = new THREE.Group();
            foreArmGroup.position.y = -0.8;
            const fore = new THREE.Mesh(new THREE.CylinderGeometry(0.12, 0.12, 0.8), skinMat);
            fore.position.y = -0.4;
            foreArmGroup.add(fore);
            const glove = new THREE.Mesh(new THREE.SphereGeometry(0.35, 16, 16), gloveMat);
            glove.position.y = -0.9; foreArmGroup.add(glove);
            armGroup.add(foreArmGroup);
            return { armGroup, foreArmGroup };
        }
        const left = createArm(-0.6, true);
        group.add(left.armGroup);
        const right = createArm(0.6, false);
        group.add(right.armGroup);
        const leftLeg = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 1.5), skinMat);
        leftLeg.position.set(-0.3, 0.75, 0); group.add(leftLeg);
        const rightLeg = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 1.5), skinMat);
        rightLeg.position.set(0.3, 0.75, 0); group.add(rightLeg);
        return { mesh: group, leftArm: left.armGroup, leftForeArm: left.foreArmGroup, rightArm: right.armGroup, rightForeArm: right.foreArmGroup };
    },
    createLetterBlock(char, xPos) {
        const canvas = document.createElement('canvas');
        canvas.width = 256; canvas.height = 256;
        const ctx = canvas.getContext('2d');
        const grd = ctx.createLinearGradient(0, 0, 256, 256);
        grd.addColorStop(0, "#D4AF37");
        grd.addColorStop(1, "#AA8822");
        ctx.fillStyle = grd; ctx.fillRect(0, 0, 256, 256);
        ctx.strokeStyle = "#FFF"; ctx.lineWidth = 10; ctx.strokeRect(5, 5, 246, 246);
        ctx.fillStyle = "#FFFFFF"; ctx.font = "bold 180px Arial";
        ctx.textAlign = "center"; ctx.textBaseline = "middle";
        ctx.fillText(char, 128, 128);
        const texture = new THREE.CanvasTexture(canvas);
        const geometry = new THREE.BoxGeometry(1.5, 1.5, 0.5);
        const material = new THREE.MeshPhongMaterial({ map: texture });
        const mesh = new THREE.Mesh(geometry, material);
        mesh.position.set(xPos, 2.5, 2); mesh.scale.set(0,0,0); mesh.castShadow = true;
        mesh.userData = { active: false, velocity: new THREE.Vector3(), rotVelocity: new THREE.Vector3() };
        this.scene.add(mesh);
        this.letterBoxes.push(mesh);
        return mesh;
    },
    createExplosion(pos) {
        const geo = new THREE.BoxGeometry(0.1, 0.1, 0.1);
        const mat = new THREE.MeshBasicMaterial({ color: 0xffcc00 });
        for(let i=0; i<20; i++) {
            const m = new THREE.Mesh(geo, mat);
            m.position.copy(pos);
            m.position.x += (Math.random()-0.5)*1.5; m.position.y += (Math.random()-0.5)*1.5;
            m.userData = { velocity: new THREE.Vector3((Math.random()-0.5)*10, (Math.random()-0.5)*10, (Math.random()-0.5)*10), life: 1.0 };
            this.scene.add(m); this.particles.push(m);
        }
    },
    createConfetti() {
        const geo = new THREE.PlaneGeometry(0.1, 0.2);
        const colors = [0xff0000, 0x00ff00, 0x0000ff, 0xffff00];
        for(let i=0; i<100; i++) {
            const m = new THREE.Mesh(geo, new THREE.MeshBasicMaterial({ color: colors[Math.floor(Math.random()*colors.length)], side: THREE.DoubleSide }));
            m.position.set((Math.random()-0.5)*20, 10+Math.random()*5, (Math.random()-0.5)*10);
            m.userData = { velocity: new THREE.Vector3((Math.random()-0.5)*0.1, -Math.random()*0.2-0.1, (Math.random()-0.5)*0.1), rotSpeed: new THREE.Vector3(Math.random()*0.2, Math.random()*0.2, 0) };
            this.scene.add(m); this.confetti.push(m);
        }
    },
    triggerPunch(hand) {
        this.boxer.mesh.userData.punching = hand;
        this.boxer.mesh.userData.punchTime = 0;
    },
    onWindowResize() {
        if(!this.camera || !this.renderer) return;
        this.camera.aspect = window.innerWidth / window.innerHeight;
        this.camera.updateProjectionMatrix();
        this.renderer.setSize(window.innerWidth, window.innerHeight);
    },
    animate() {
        if (!this.isAnimating) return;
        this.animationId = requestAnimationFrame(() => this.animate());
        const delta = this.clock.getDelta();
        const elapsed = this.clock.getElapsedTime();
        this.timeline += delta;
        if(this.currentStep < this.SEQUENCE.length) {
            const seq = this.SEQUENCE[this.currentStep];
            if(this.timeline >= seq.time - 0.4 && !seq.spawned) {
                const box = this.createLetterBlock(seq.char, seq.pos);
                box.userData.active = true;
                seq.spawned = true;
            }
            if(this.timeline >= seq.time && !seq.punched) {
                this.triggerPunch(seq.hand);
                this.createExplosion(new THREE.Vector3(seq.pos, 2.5, 2));
                const box = this.letterBoxes[this.letterBoxes.length-1];
                if(box) { box.scale.set(1.5, 1.5, 1.5); box.userData.rotVelocity.set((Math.random()-0.5)*5, (Math.random()-0.5)*5, 0); }
                if(seq.finish) { 
                    this.createConfetti();
                    this.boxer.leftArm.rotation.set(0, 0, 2.9);
                    this.boxer.rightArm.rotation.set(0, 0, -2.9);
                }
                seq.punched = true;
                this.currentStep++;
            }
        }
        if(!this.boxer.mesh.userData.punching) {
            this.boxer.mesh.position.y = Math.sin(elapsed * 5) * 0.05;
        } else {
            const hand = this.boxer.mesh.userData.punching;
            this.boxer.mesh.userData.punchTime += delta * 8;
            const pt = this.boxer.mesh.userData.punchTime;
            const val = Math.sin(Math.min(pt, Math.PI));
            const arm = hand==='left' ? this.boxer.leftArm : this.boxer.rightArm;
            const fore = hand==='left' ? this.boxer.leftForeArm : this.boxer.rightForeArm;
            arm.rotation.x = 0.78 - (val * 1.5);
            fore.rotation.x = 2.09 - (val * 1.5);
            if(pt >= Math.PI) this.boxer.mesh.userData.punching = null;
        }
        this.letterBoxes.forEach(b => {
            if(b.userData.active) {
                b.scale.lerp(new THREE.Vector3(1,1,1), 0.1);
                b.rotation.x += b.userData.rotVelocity.x * delta;
                b.userData.rotVelocity.multiplyScalar(0.9);
                b.rotation.x = THREE.MathUtils.lerp(b.rotation.x, 0, 0.1);
            }
        });
        [...this.particles, ...this.confetti].forEach(p => {
             p.position.add(p.userData.velocity);
             if(p.userData.life) p.userData.life -= delta;
        });
        this.renderer.render(this.scene, this.camera);
    }
};

function pickWord() {
    // *** BOSS BATTLE TRIGGER (15th Word) ***
    if (roundWins === 14) {
        startBossRound();
        return;
    }

    // Normal Game Loop
    isBossRound = false;
    document.body.classList.remove('boss-mode'); // Safety cleanup

    const set = WORD_SETS[levelChoice] || WORD_SETS[1];
    const bagKey = `sb_wordBag_lvl_${levelChoice}`;
    
    // Bag Logic (Same as before)
    let bag = JSON.parse(localStorage.getItem(bagKey) || '[]');
    if (bag.length === 0 || bag.some(i => i >= set.length)) {
        bag = Array.from({length: set.length}, (_, i) => i);
        bag = shuffle(bag);
    }
    const nextIndex = bag.pop();
    localStorage.setItem(bagKey, JSON.stringify(bag));
    
    const data = set[nextIndex];
    currentWord = data.word.toUpperCase();
    el.puzzleImage.textContent = data.emoji;
    
    renderWord();
    // *** NEW: Update Background Theme ***
    document.body.className = `lvl-${levelChoice}`; 
    // ************************************
}

// *** NEW FUNCTION: Sets up the Boss Fight ***
function startBossRound() {
    isBossRound = true;
    
    // 1. Visuals & Audio
    document.body.classList.add('boss-mode');
    playSpeech("Warning! End of Level!");
    flashFeedback("‚ö†Ô∏è BOSS WORD! ‚ö†Ô∏è");
    
    // 2. Pick a Harder Word (From next level up, or just a hard one)
    let bossLevel = Math.min(levelChoice + 1, 5);
    const set = WORD_SETS[bossLevel];
    
    // Pick random word from harder set (Don't use bag, just random challenge)
    const data = set[Math.floor(Math.random() * set.length)];
    
    currentWord = data.word.toUpperCase();
    el.puzzleImage.textContent = data.emoji;
    
    renderWord();
}

function renderWord(){
  userAnswer=Array(currentWord.length).fill(null);
  el.slots.innerHTML='';
  el.tiles.innerHTML='';
  
  const letters=currentWord.split('');
  // Add extra letters for difficulty
  const extras='ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').sort(()=>0.5-Math.random()).slice(0,Math.max(0,Math.min(3,Math.floor(letters.length/2))));
  const tiles = shuffle([...letters,...extras]);

  // Render Slots (Empty Boxes)
  letters.forEach((l, i)=>{ 
    const s=document.createElement('div'); 
    s.className='slot'; 
    s.dataset.index=i; 
    s.addEventListener('click',()=>onSlotClick(s)); 
    el.slots.appendChild(s); 
  });

  // Render Tiles (Colored Letters)
  tiles.forEach((l, i)=>{
    const t=document.createElement('div'); 
    
    // *** NEW: Color Logic ***
    const isVowel = ['A','E','I','O','U'].includes(l);
    // Apply the class based on the letter type
    t.className = isVowel ? 'letter vowel' : 'letter consonant';
    // ************************

    t.textContent=l; 
    t.dataset.letter=l;
    t.dataset.originalId = i;
    t.addEventListener('click',()=>{ onTileClick(t); playSpeech(t.dataset.letter.toLowerCase()); });
    el.tiles.appendChild(t);
  });

  el.feedback.textContent='';
  updateHUD();
}

function onTileClick(tile){
  if(tile.style.visibility==='hidden' || isAnimating) return;
  const slotIndex = userAnswer.findIndex(l => l === null);
  if(slotIndex === -1) { flashFeedback("Boxes are full!"); return; }
  const emptySlot = el.slots.children[slotIndex];
  emptySlot.textContent = tile.dataset.letter;
  emptySlot.dataset.sourceId = tile.dataset.originalId; 
  tile.style.visibility='hidden';
  userAnswer[slotIndex]=tile.dataset.letter;
}

function onSlotClick(slot){
  if(isAnimating) return;
  const i=Number(slot.dataset.index);
  if(slot.textContent){
    const originalId = slot.dataset.sourceId;
    const letter = slot.textContent;
    slot.textContent='';
    slot.dataset.sourceId = '';
    userAnswer[i]=null;
    const hidden = Array.from(el.tiles.children).find(t=>t.dataset.originalId === originalId);
    if(hidden) hidden.style.visibility='';
    playSpeech(letter.toLowerCase());
  }
}

function playAnnouncer(currentStreak) {
    let announcement = '';
    if (currentStreak === 10) announcement = "Coin Rush initiated!";
    else if (currentStreak === 15) announcement = "Unstoppable!";
    else if (currentStreak === 20) announcement = "Legendary streak!";
    if (announcement) playSpeech(announcement);
}

function submit(){
  if(isAnimating) return;
  const attempt=userAnswer.filter(l=>l).join('');
  if(attempt.length!==currentWord.length) { flashFeedback("Fill all the boxes first!"); return; }
  if(attempt===currentWord) handleCorrect(); else handleWrong();
}

function levelUp() {
    if (typeof VictoryScene !== 'undefined') { VictoryScene.start(); } else { finishLevelUp(); }
}
function finishLevelUp() {
    roundWins = 0;
    if (levelChoice < 5) {
        levelChoice++;
        localStorage.setItem('wordIndex', 0);
        if(el.levelSelect) { el.levelSelect.value = levelChoice; }
        flashFeedback(`LEVEL ${levelChoice} UNLOCKED!`);
    } else {
         flashFeedback("MAX LEVEL REACHED!");
    }
    saveStore();
    updateHUD();
    isAnimating = false;
    pickWord(); 
}

function handleCorrect(){
  isAnimating = true;
  let baseXP = 5; let bonusXP = 0; let bonusCoins = 0; let baseScore = 10;
  if (levelChoice >= 3) baseXP = 7;
  if (levelChoice >= 2) bonusCoins += 1;
  if (levelChoice >= 5) baseScore += 5;
  if (currentGlove === 'training') bonusXP += 1;
  if (currentGlove === 'sparkle') bonusCoins += 1;

  let rushMultiplier = 1; let rushActive = false;
  if (coinRushCounter > 0) {
      rushMultiplier = COIN_RUSH_MULTIPLIER;
      coinRushCounter--;
      rushActive = true;
  } else if (streak === 9) { 
      coinRushCounter = COIN_RUSH_DURATION;
      rushMultiplier = COIN_RUSH_MULTIPLIER;
      rushActive = true;
      playAnnouncer(streak + 1);
  }
  
  let multiplier = 1;
  if (streak >= 5) multiplier = 1.5;
  if (streak >= 10) multiplier = 2;
  if (streak >= 20) multiplier = 4;
// 2. Coin Calculation
  let baseCoinReward = 5;
  let streakBonusCoins = Math.floor(streak / 5); 
  let totalCoinsEarned = (baseCoinReward + streakBonusCoins + bonusCoins);
  
  if (rushActive) totalCoinsEarned *= COIN_RUSH_MULTIPLIER;

  // *** BOSS REWARD (Triple Coins) ***
  if (isBossRound) {
      totalCoinsEarned *= 3;
      flashFeedback("BOSS DEFEATED! 3x COINS!");
      playSpeech("Boss Defeated!");
      document.body.classList.remove('boss-mode'); // Turn off alarms
  }

  let gained = Math.round(baseScore * multiplier);
  if (currentGlove === 'star') gained = Math.round(baseScore * (1 + (currentWord.length / 2)));
  if (currentGlove === 'gold' && streak >= 3) { gained += 25; totalCoinsEarned += 5; }

  score += (gained * (rushActive ? rushMultiplier : 1));
  coins += totalCoinsEarned;
  xp+=(baseXP + bonusXP);
  streak+=1;
  wordsSpelled+=1;
  if (streak > maxStreak) maxStreak = streak;
  roundWins++;

  if (levelChoice >= 3) {
    el.xpContainer.classList.add('xp-flash');
    setTimeout(() => el.xpContainer.classList.remove('xp-flash'), 300);
  }
  if (xp >= 50) {
      xp = 0; coins += 50; flashFeedback("RANK UP! +50 COINS!");
  }
  
  showPunch(true,gained);
  correctSound.play().catch(() => {});
  flashFeedback("HIT!");
  playSpeech(currentWord.toLowerCase()); 

  if (roundWins % 3 === 0 && roundWins < 15) {
      const praises = ["Great job!", "Fantastic!", "Superb!", "Amazing!", "Well done!", "Incredible!", "You are on fire!", "Spectacular!", "Excellent!"];
      const randomPraise = praises[Math.floor(Math.random() * praises.length)];
      setTimeout(() => playSpeech(randomPraise), 800);
  }

  saveStore(); 
  updateHUD(); 
  
  if (roundWins >= 15) {
      setTimeout(() => {
          playSpeech("LEVEL UP!"); 
          levelUp(); 
      }, 1500);
  } else {
      setTimeout(()=>{ isAnimating = false; pickWord(); }, 1500);
  }
}

function handleWrong(){
  isAnimating = true;
  let feedbackMessage = "TRY AGAIN!";
  if (levelChoice >= 4) {
      if (streak > 0) {
        streak = Math.max(1, streak - 1);
        el.streak.classList.add('streak-guard-flash');
        setTimeout(() => el.streak.classList.remove('streak-guard-flash'), 600);
        feedbackMessage = "GUARD! Streak Protected.";
      }
  } else { streak = 0; }
  if (coinRushCounter > 0) { coinRushCounter = 0; feedbackMessage = "RUSH FAILED! Streak Reset."; }
  
  showPunch(false,0); 
  wrongSound.play().catch(() => {});
  flashFeedback(feedbackMessage);
  score=Math.max(0,score-2); 
  saveStore(); 
  updateHUD();
  setTimeout(() => { isAnimating = false; }, 600);
}

function showPunch(hit, gained) {
    const glove = el.glove, balloon = el.puzzleImage;
    glove.classList.remove('punching');
    balloon.classList.remove('balloonHit');

    if (hit) {
        glove.classList.add('punching');
        balloon.classList.add('balloonHit');
        punchSound.play().catch(() => {});
        let pColors = ['#ffffff', '#ffb400'];
        let pShapes = ['square'];
        if (currentGlove === 'fire') { pColors = ['#ff0000', '#ff4500', '#fbbf24']; pShapes = ['square']; }
        else if (currentGlove === 'ice') { pColors = ['#a5f3fc', '#ffffff', '#0ea5e9']; pShapes = ['circle']; }
        else if (currentGlove === 'zombie' || currentGlove === 'slime') { pColors = ['#84cc16', '#3f6212', '#bef264']; pShapes = ['circle']; }
        else if (currentGlove === 'gold' || currentGlove === 'sparkle') { pColors = ['#FFD700', '#FDB931', '#FFFFFF']; pShapes = ['circle']; }
        confetti({ particleCount: 30, spread: 60, origin: { y: 0.6 }, colors: pColors, shapes: pShapes, disableForReducedMotion: true });
        setTimeout(() => { glove.classList.remove('punching'); balloon.classList.remove('balloonHit'); }, 600);
    } else {
        glove.classList.add('punching');
        setTimeout(() => { glove.classList.remove('punching'); }, 500);
    }
}

function renderProgressModal() {
    el.progressContent.innerHTML = `
        <div class="text-lg font-semibold border-b pb-2 mb-2">Current Status</div>
        <p>Level: <span class="font-bold text-blue-600">LVL ${levelChoice}</span></p>
        <p>XP: <span class="font-bold">${xp} / 50</span></p>
        <p>Current Streak: <span class="font-bold">${streak}</span></p>
        ${coinRushCounter > 0 ? `<p class="text-red-500 font-bold">COIN RUSH ACTIVE: ${coinRushCounter} words left!</p>` : ''}
        <div class="text-lg font-semibold border-b pb-2 pt-4 mb-2">Lifetime Achievements</div>
        <p>Total Score Earned: <span class="font-bold">${score}</span></p>
        <p>Max Streak: <span class="font-bold">${maxStreak}</span></p>
        <p>Total Words Spelled: <span class="font-bold">${wordsSpelled}</span></p>
    `;
    el.progressModal.style.display = 'flex';
}

function renderShop() {
    el.shopContent.innerHTML = `
        <div class="flex gap-2 mb-4 border-b border-gray-600 pb-2">
            <button onclick="switchTab('gloves')" class="flex-1 py-2 rounded-t-lg font-bold text-lg ${shopTab === 'gloves' ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-400'}">ü•ä Gloves</button>
            <button onclick="switchTab('stickers')" class="flex-1 py-2 rounded-t-lg font-bold text-lg ${shopTab === 'stickers' ? 'bg-purple-600 text-white' : 'bg-gray-700 text-gray-400'}">üìí Stickers</button>
        </div>
        <div id="shopInnerContent" class="h-[50vh] overflow-y-auto pr-2"></div>
    `;
    const inner = document.getElementById('shopInnerContent');
    if (shopTab === 'gloves') { renderGloves(inner); } else { renderStickers(inner); }
    el.shopModal.classList.remove('hidden'); el.shopModal.classList.add('flex');
}

function renderGloves(container) {
    const powerUpIDs = ['training', 'sparkle', 'gold'];
    const vanityIDs = Object.keys(GLOVE_DATA).filter(id => !powerUpIDs.includes(id) && id !== 'base');
    const makeCard = (id) => {
        const data = GLOVE_DATA[id];
        const owned = ownedGloves.includes(id);
        const equipped = currentGlove === id;
        let btnStr = owned ? (equipped ? "EQUIPPED" : "EQUIP") : `BUY ${data.price}üí∞`;
        let btnCls = owned ? (equipped ? "bg-green-600 cursor-default" : "bg-blue-500 hover:bg-blue-400") : (coins >= data.price ? "bg-amber-500 hover:bg-amber-400" : "bg-gray-600 cursor-not-allowed");
        return `
        <div class="bg-white/5 p-3 rounded-xl flex flex-col items-center border border-white/10 relative group hover:border-white/30 transition mb-2">
            <div class="text-5xl mb-2 transform group-hover:scale-110 transition">${data.emoji}</div>
            <div class="font-bold text-white text-md">${data.name}</div>
            <div class="text-xs text-gray-400 mb-2 font-bold uppercase">${data.perk}</div>
            <button onclick="handleShopAction('${id}', ${data.price}, ${owned})" class="w-full py-2 rounded-lg font-black text-white text-xs shadow-md ${btnCls}" ${(!owned && coins < data.price) ? 'disabled' : ''}>${btnStr}</button>
        </div>`;
    };
    let html = `<div class="grid grid-cols-2 sm:grid-cols-3 gap-3"><h3 class="col-span-full text-xl font-black text-yellow-400 border-b-2 border-yellow-400/20 pb-1 mb-2 mt-1">‚ö° POWER UPS</h3>`;
    html += powerUpIDs.map(id => makeCard(id)).join('');
    html += `<h3 class="col-span-full text-xl font-black text-purple-400 border-b-2 border-purple-400/20 pb-1 mb-2 mt-6">üé≠ COOL STYLES</h3>`;
    html += vanityIDs.map(id => makeCard(id)).join('');
    html += `</div>`;
    container.innerHTML = html;
}

function renderStickers(container) {
    if (!STICKER_DATA) { container.innerHTML = '<div class="text-center text-gray-500">Sticker data missing!</div>'; return; }
    let html = `<div class="grid grid-cols-2 sm:grid-cols-3 gap-3">`;
    html += Object.entries(STICKER_DATA).map(([id, data]) => {
        const owned = ownedStickers.includes(id);
        const btnClass = owned ? 'bg-gray-600 cursor-default' : (coins >= data.price ? 'bg-purple-500 hover:bg-purple-400' : 'bg-gray-700 cursor-not-allowed');
        const btnText = owned ? 'OWNED' : `BUY ${data.price}üí∞`;
        return `
        <div class="bg-white/5 p-3 rounded-xl flex flex-col items-center border border-white/10">
            <div class="text-5xl mb-2">${data.emoji}</div>
            <div class="font-bold text-white">${data.name}</div>
            <button class="w-full mt-2 rounded-lg py-2 font-bold text-xs text-white ${btnClass}" onclick="buySticker('${id}')" ${owned?'disabled':''}>${btnText}</button>
        </div>`;
    }).join('');
    html += `</div>`;
    container.innerHTML = html;
}

window.switchTab = function(tab) { shopTab = tab; renderShop(); };
window.handleShopAction = (gloveId, price, isOwned) => {
    if (isOwned === true) {
        currentGlove = gloveId;
        playSpeech(`${GLOVE_DATA[gloveId].name} equipped!`);
        updateHUD(); saveStore(); renderShop();
    } else if (coins >= price) {
        coins -= price;
        ownedGloves.push(gloveId);
        currentGlove = gloveId;
        playSpeech(`Purchased and equipped ${GLOVE_DATA[gloveId].name}!`);
        updateHUD(); saveStore(); renderShop();
    } else { playSpeech("Not enough coins!"); }
};

document.addEventListener('keydown', e=>{
  if (isAnimating) return;
  if(e.key==='Backspace'){ 
    e.preventDefault();
    const lastFilledIndex = [...userAnswer].reverse().findIndex(l => l !== null);
    if (lastFilledIndex !== -1) { onSlotClick(el.slots.children[currentWord.length - 1 - lastFilledIndex]); }
  }
  else if(e.key==='Enter'){ e.preventDefault(); submit(); }
  else if(/^[a-zA-Z]$/.test(e.key)){ 
    e.preventDefault();
    const letter=e.key.toUpperCase(); 
    const tile=Array.from(el.tiles.children).find(t=>t.dataset.letter===letter && t.style.visibility!=='hidden'); 
    if(tile) { onTileClick(tile); playSpeech(letter.toLowerCase()); }
  }
});

el.emojiBtn.addEventListener('click',()=>playSpeech(currentWord.toLowerCase()));
el.submit.addEventListener('click',submit);
el.newBtn.addEventListener('click',pickWord);
el.shopBtn.addEventListener('click', renderShop);
el.closeShop.addEventListener('click', () => { el.shopModal.classList.add('hidden'); el.shopModal.classList.remove('flex'); });
el.statsHeader.addEventListener('click', renderProgressModal);
el.closeProgressModal.addEventListener('click', () => { el.progressModal.style.display = 'none'; });
el.themeToggle.addEventListener('click', () => {
    const body = document.body;
    const currentTheme = body.getAttribute('data-theme') || 'light';
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    body.setAttribute('data-theme', newTheme);
    localStorage.setItem('sb_theme', newTheme);
});
el.levelSelect.value=levelChoice;
el.levelSelect.addEventListener('change',e=>{ levelChoice=parseInt(e.target.value); localStorage.setItem('sb_level',levelChoice); localStorage.setItem('wordIndex', 0); pickWord(); });

function flashFeedback(t){ el.feedback.textContent=t; setTimeout(()=>{ if(el.feedback.textContent===t) el.feedback.textContent=''; },1500); }
function saveStore(){ localStorage.setItem('spellingBalloon_v2',JSON.stringify({ coins, score, xp, streak, maxStreak, wordsSpelled, currentGlove, ownedGloves, levelChoice, coinRushCounter, roundWins, ownedStickers, placedStickers })); }
function updateHUD(){ 
  const xpNextGoal = 50;
  el.score.textContent=`Score: ${score}`; el.coins.textContent=coins; el.xp.textContent=xp; el.xpNext.textContent=xpNextGoal; el.streak.textContent=streak; el.glove.textContent = GLOVE_DATA[currentGlove].emoji;
  if(el.levelDisplay) el.levelDisplay.textContent = `LVL ${levelChoice}`;
  if (levelChoice >= 2) { el.coins.classList.add('gold-boost'); } else { el.coins.classList.remove('gold-boost'); }
  if (levelChoice >= 4) { el.streak.classList.add('streak-guard'); } else { el.streak.classList.remove('streak-guard'); }
  const maxCombo = 20;
  const percentage = Math.min((streak / maxCombo) * 100, 100);
  const bar = document.getElementById('streakBar');
  if(bar) { 
      bar.style.width = percentage + '%';
      if (streak >= 10) { bar.classList.add('animate-pulse'); bar.parentElement.style.boxShadow = '0 0 15px #ff4500'; bar.parentElement.style.borderColor = '#ff4500'; } 
      else { bar.classList.remove('animate-pulse'); bar.parentElement.style.boxShadow = 'none'; bar.parentElement.style.borderColor = '#4b5563'; }
  }
}

// Sticker Logic
if(el.stickerBtn) el.stickerBtn.addEventListener('click', openStickerBook);
if(el.closeStickerModal) el.closeStickerModal.addEventListener('click', () => { el.stickerModal.style.display = 'none'; });
let selectedStickerIndex = null;
function openStickerBook() { el.stickerModal.style.display = 'flex'; renderStickerDrawer(); renderPlacedStickers(); }
function renderStickerDrawer() {
    const drawer = el.stickerDrawer;
    if (ownedStickers.length === 0) { drawer.innerHTML = '<div class="w-full text-center text-gray-500 font-bold text-xl">Go to Shop to buy stickers!</div>'; return; }
    drawer.innerHTML = ownedStickers.map(id => `
        <div class="min-w-[80px] h-[80px] bg-white/10 rounded-xl flex items-center justify-center text-5xl cursor-pointer hover:bg-white/20 hover:scale-110 transition shadow-lg border-2 border-white/5 active:scale-95" onclick="placeSticker('${id}')">${STICKER_DATA[id].emoji}</div>
    `).join('');
}
window.buySticker = (id) => {
    const data = STICKER_DATA[id];
    if(coins >= data.price && !ownedStickers.includes(id)) { coins -= data.price; ownedStickers.push(id); playSpeech("New Sticker!"); saveStore(); updateHUD(); renderShop(); } 
    else if (ownedStickers.includes(id)) { playSpeech("You own this!"); } else { playSpeech("Not enough coins"); }
};
window.placeSticker = (id) => {
    // 1. CHECK: Is this sticker already on the canvas?
    const alreadyExists = placedStickers.some(s => s.id === id);
    
    if (alreadyExists) {
        playSpeech("Already here!"); // Feedback
        
        // Optional: Find it and shake it/highlight it so they see it
        const index = placedStickers.findIndex(s => s.id === id);
        selectedStickerIndex = index; // Auto-select the existing one
        renderPlacedStickers(); 
        return; // STOP here. Do not create a new one.
    }

    // 2. If not found, create it (The original code)
    placedStickers.push({
        id: id, 
        emoji: STICKER_DATA[id].emoji, 
        x: 40 + (Math.random() * 20), 
        y: 40 + (Math.random() * 20), 
        size: 5 
    });
    
    playSpeech("Pop!"); 
    saveStore(); 
    renderPlacedStickers();
};
function renderPlacedStickers() {
    const canvas = el.stickerCanvas;
    // Clear old items (keep grid and controls)
    const oldItems = canvas.querySelectorAll('.sticker-item, #stickerControls');
    oldItems.forEach(e => e.remove());

    // --- TOOLBAR LOGIC ---
    if(selectedStickerIndex !== null) {
        const bar = document.createElement('div');
        bar.id = 'stickerControls';
        // Float slightly ABOVE the selection
        bar.className = 'absolute bottom-8 left-1/2 transform -translate-x-1/2 bg-slate-900 p-2 rounded-2xl flex gap-3 shadow-2xl z-[100] border-2 border-white/20';
        bar.innerHTML = `
            <button onclick="modSticker('shrink')" class="w-12 h-12 bg-blue-600 active:bg-blue-500 rounded-xl text-2xl shadow-lg border-b-4 border-blue-800 active:border-b-0 active:translate-y-1">‚ûñ</button>
            <button onclick="modSticker('grow')" class="w-12 h-12 bg-green-600 active:bg-green-500 rounded-xl text-2xl shadow-lg border-b-4 border-green-800 active:border-b-0 active:translate-y-1">‚ûï</button>
            <div class="w-[2px] bg-gray-600 mx-1"></div>
            <button onclick="modSticker('del')" class="w-12 h-12 bg-red-600 active:bg-red-500 rounded-xl text-2xl shadow-lg border-b-4 border-red-800 active:border-b-0 active:translate-y-1">üóëÔ∏è</button>
            <button onclick="modSticker('close')" class="w-12 h-12 bg-gray-600 active:bg-gray-500 rounded-xl text-xl shadow-lg border-b-4 border-gray-800 active:border-b-0 active:translate-y-1">‚úñÔ∏è</button>
        `;
        canvas.appendChild(bar);
    }

    // --- RENDER STICKERS ---
    placedStickers.forEach((s, index) => {
        const d = document.createElement('div');
        d.className = 'sticker-item';
        d.textContent = s.emoji;
        d.style.left = s.x + '%';
        d.style.top = s.y + '%';
        d.style.fontSize = s.size + 'rem';
        d.style.zIndex = index + 10;
        d.style.transform = 'translate(-50%, -50%)';
        
        // Highlight selection
        if(index === selectedStickerIndex) {
            d.style.border = '3px dashed #ffb400';
            d.style.backgroundColor = 'rgba(255,255,255,0.1)';
            d.style.borderRadius = '12px';
            d.style.zIndex = 50; 
        }

        // Touch/Click to Select
        d.onmousedown = (e) => startDrag(e, index);
        d.ontouchstart = (e) => startDrag(e, index);
        
        canvas.appendChild(d);
    });
}
window.modSticker = (action) => {
    if(action === 'close') { selectedStickerIndex = null; renderPlacedStickers(); return; }
    if(selectedStickerIndex === null) return;
    const s = placedStickers[selectedStickerIndex];
    if(action === 'grow') { s.size = Math.min(s.size+1, 12); playSpeech("Big"); }
    if(action === 'shrink') { s.size = Math.max(s.size-1, 2); playSpeech("Small"); }
    if(action === 'del') { placedStickers.splice(selectedStickerIndex, 1); selectedStickerIndex = null; playSpeech("Deleted"); }
    saveStore(); renderPlacedStickers();
};
let dragIdx = null;
function startDrag(e, index) {
    if(e.type === 'touchstart') e.preventDefault();
    selectedStickerIndex = index; renderPlacedStickers();
    dragIdx = index;
    const moveHandler = (ev) => {
        if (dragIdx === null) return;
        const rect = el.stickerCanvas.getBoundingClientRect();
        const clientX = ev.touches ? ev.touches[0].clientX : ev.clientX;
        const clientY = ev.touches ? ev.touches[0].clientY : ev.clientY;
        let newX = ((clientX - rect.left) / rect.width) * 100;
        let newY = ((clientY - rect.top) / rect.height) * 100;
        placedStickers[dragIdx].x = newX; placedStickers[dragIdx].y = newY;
        renderPlacedStickers();
    };
    const upHandler = () => { dragIdx = null; saveStore(); document.removeEventListener('mousemove', moveHandler); document.removeEventListener('mouseup', upHandler); document.removeEventListener('touchmove', moveHandler); document.removeEventListener('touchend', upHandler); };
    document.addEventListener('mousemove', moveHandler); document.addEventListener('mouseup', upHandler); document.addEventListener('touchmove', moveHandler, { passive: false }); document.addEventListener('touchend', upHandler);
}
if(el.stickerCanvas) { el.stickerCanvas.addEventListener('mousedown', (e) => { if(e.target === el.stickerCanvas || e.target.classList.contains('absolute')) { selectedStickerIndex = null; renderPlacedStickers(); } }); el.stickerCanvas.addEventListener('touchstart', (e) => { if(e.target === el.stickerCanvas || e.target.classList.contains('absolute')) { selectedStickerIndex = null; renderPlacedStickers(); } }); }

// Init
document.body.setAttribute('data-theme', localStorage.getItem('sb_theme') || 'dark');
pickWord(); updateHUD(); saveStore();
const introScreen = document.getElementById('introScreen');
const startBtn = document.getElementById('startGameBtn');
if(startBtn) {
    startBtn.addEventListener('click', () => {
        playSpeech("Let's get ready to rumble!");
        if(typeof confetti === 'function') { confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 }, colors: ['#FFD700', '#FF0000', '#FFFFFF'] }); }
        introScreen.style.opacity = '0'; introScreen.style.pointerEvents = 'none'; 
        setTimeout(() => { introScreen.style.display = 'none'; pickWord(); }, 500);
    });
}
// Loot Box Logic
const lootOverlay = document.getElementById('lootOverlay');
const lootCrate = document.getElementById('lootCrate');
const lootRewards = document.getElementById('lootRewards');
const lootItems = document.getElementById('lootItems');
const collectBtn = document.getElementById('collectLootBtn');
let crateClicks = 0;
const CLICKS_TO_OPEN = 5;
if (lootOverlay && lootCrate && collectBtn) {
    lootCrate.addEventListener('click', () => {
        crateClicks++;
        lootCrate.classList.remove('crate-shake'); void lootCrate.offsetWidth; lootCrate.classList.add('crate-shake');
        playSpeech("Thud!");
        if (crateClicks >= CLICKS_TO_OPEN) { openCrate(); }
    });
    collectBtn.addEventListener('click', () => {
        lootOverlay.classList.add('hidden'); lootOverlay.classList.remove('flex');
        if(typeof finishLevelUp === 'function') { finishLevelUp(); } else { isAnimating = false; pickWord(); }
    });
}
function triggerLootBox() {
    if (!lootOverlay || !lootCrate) { if(typeof finishLevelUp === 'function') finishLevelUp(); return; }
    lootOverlay.classList.remove('hidden'); lootOverlay.classList.add('flex');
    crateClicks = 0; lootCrate.style.display = 'block'; lootRewards.classList.add('hidden'); lootRewards.classList.remove('flex');
    lootCrate.textContent = 'üì¶'; lootCrate.classList.remove('crate-shake');
    lootCrate.classList.remove('crate-drop'); void lootCrate.offsetWidth; lootCrate.classList.add('crate-drop');
    playSpeech("Loot Crate!");
}
function openCrate() {
    lootCrate.style.display = 'none'; lootRewards.classList.remove('hidden'); lootRewards.classList.add('flex');
    playSpeech("Jackpot!");
    if(typeof confetti === 'function') { confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } }); }
    let rewardsHTML = '';
    for(let i=0; i<3; i++) {
        const isCoin = Math.random() > 0.5;
        if(isCoin) {
            coins += 50;
            rewardsHTML += `<div class="bg-slate-800 p-4 rounded-xl border-2 border-yellow-500 text-center w-24"><div class="text-4xl">üí∞</div><div class="text-white font-bold text-sm">+50</div></div>`;
        } else {
            if (typeof STICKER_DATA !== 'undefined') {
                const stickerKeys = Object.keys(STICKER_DATA);
                const randId = stickerKeys[Math.floor(Math.random() * stickerKeys.length)];
                const sticker = STICKER_DATA[randId];
                if(!ownedStickers.includes(randId)) {
                    ownedStickers.push(randId);
                    rewardsHTML += `<div class="bg-slate-800 p-4 rounded-xl border-2 border-purple-500 text-center w-24"><div class="text-4xl">${sticker.emoji}</div><div class="text-white font-bold text-sm">NEW!</div></div>`;
                } else {
                    coins += 25; rewardsHTML += `<div class="bg-slate-800 p-4 rounded-xl border-2 border-gray-500 text-center w-24"><div class="text-4xl">üí∞</div><div class="text-white font-bold text-sm">+25</div></div>`;
                }
            }
        }
    }
    lootItems.innerHTML = rewardsHTML; saveStore(); updateHUD();
}

</script>
</body>
</html>